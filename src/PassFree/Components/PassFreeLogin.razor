@using System.Net.Mail
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Options
@inject IHttpContextAccessor HttpContextAccessor;
@inject IOptions<PassFreeOptions> Options
@inject NavigationManager Navigation;
@inject PasswordFreeAuthenticationProvider PasswordFreeAuthenticationProvider;
@inject IPassFreeService PassFreeService;

<div class="passfree-login">
    <h2>@Options.Value.PageTitle</h2>

    @if (LoginStatus is LoginStatus.RequestEmail or LoginStatus.NotAuthenticated)
    {
        <form method="post" action="@Options.Value.LoginPath" @formname="passfree-login-form" data-enhance="false">
            <div class="passfree-form-group">
                <label for="emailaddress">Email Address</label>
                <input type="text" id="emailaddress" name="emailaddress" required/>
                <input type="submit" value="Submit"/>
            </div>
            <AntiforgeryToken/>
        </form>


        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="passfree-error">@ErrorMessage</div>
        }
    }

    @if (LoginStatus == LoginStatus.LoginLinkSent)
    {
        <div class="login-link-sent">
            <p class="text">We have sent you a login link.</p>
            <p class="text">Please check your inbox and click the link to login.</p>
            <p class="text">
                Wrong email or no email received?
                <a href="@Options.Value.DefaultRedirectPath"
                   class="link">Try again.</a>
            </p>
        </div>
    }

    @if (LoginStatus == LoginStatus.LoginFailed)
    {
        <div class="login-failed">
            <p class="text">Login failed. This could be because you are not authorized, or your login link
                expired,
                or you are trying to log in from another device or browser.</p>
            <p class="text">
                <a href="@Options.Value.DefaultRedirectPath"
                   class="link">Try again.</a>
            </p>
        </div>
    }

    @if (LoginStatus == LoginStatus.LoginSucceeded)
    {
        <div class="login-succeeded"
             x-data="loginCountdown()"
             x-init="init()">
            <h3 class="text">Login Succeeded.</h3>
            <p class="text" x-text="displayText"></p>
            <em>
                If you are not redirected, or want to navigate quicker, please click
                <a href="@Options.Value.SuccessRedirectPath"
                   class="link">here.</a>
            </em>
        </div>
    }
</div>
<script defer src="https://cdn.jsdelivr.net/npm/@@alpinejs/csp@3.15.0/dist/cdn.min.js"
        integrity="sha384-/RME6pSq0zKJyBifgNWPb3I8kZckbbyQzvFaUqSyfcw3anF1SmYxV5XUPlkZxTBZ"
        crossorigin="anonymous"></script>

<script>
    function loginCountdown() {
        return {
            redirectCount: 4,
            get displayText() {
                return `You will be redirected to the home page in ${this.redirectCount} seconds.`;
            },
            init() {
                const startTime = Date.now();
                const duration = 4000;

                const update = () => {
                    const elapsed = Date.now() - startTime;
                    const remaining = Math.max(0, Math.ceil((duration - elapsed) / 1000));
                    this.redirectCount = remaining;

                    if (remaining > 0) {
                        requestAnimationFrame(update);
                    } else {
                        window.location.href = '@Options.Value.SuccessRedirectPath';
                    }
                };

                requestAnimationFrame(update);
            }
        }
    }
</script>

@code {
    [SupplyParameterFromQuery] private string? ErrorMessage { get; set; }

    [SupplyParameterFromQuery] private string? Status { get; set; }

    private LoginStatus LoginStatus { get; set; }

    [SupplyParameterFromQuery] public string? AuthToken { get; set; }


    protected override async Task OnInitializedAsync()
    {
        LoginStatus = !string.IsNullOrWhiteSpace(Status)
            ? Enum.Parse<LoginStatus>(Status)
            : LoginStatus.NotAuthenticated;

        if (HttpContextAccessor.HttpContext?.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("");
            return;
        }

        if (ShouldSkipProcessing())
        {
            return;
        }

        if (LoginStatus == LoginStatus.LoginLinkSent && !string.IsNullOrWhiteSpace(AuthToken))
        {
            await ProcessLoginAsync();
        }
    }

    private bool ShouldSkipProcessing()
    {
        return LoginStatus is LoginStatus.NotAuthenticated
                   or LoginStatus.RequestEmail
                   or LoginStatus.LoginSucceeded
                   or LoginStatus.LoginFailed
               || (LoginStatus == LoginStatus.LoginLinkSent && string.IsNullOrWhiteSpace(AuthToken));
    }

    private async Task ProcessLoginAsync()
    {
        var request = HttpContextAccessor.HttpContext?.Request!;

        if (!request.Cookies.TryGetValue(Options.Value.CorrelationIdCookieKey, out var correlationIdToken))
        {
            LoginStatus = LoginStatus.LoginFailed;
            return;
        }

        var (validationResult, user) = PasswordFreeAuthenticationProvider.ValidateTokens(AuthToken, correlationIdToken);
        if (validationResult != PassFreeAuthenticaionTokenValidationResult.Success)
        {
            LoginStatus = LoginStatus.LoginFailed;
            return;
        }

        var isAuthorized = await PassFreeService.IsAuthorizedToLogin(user);
        if (!isAuthorized)
        {
            LoginStatus = LoginStatus.LoginFailed;
            return;
        }

        await SignInUserAsync(user);
    }

    private async Task SignInUserAsync(MailAddress user)
    {
        var claims = new[] { new Claim("email", user.Address) };
        var claimsIdentity = new ClaimsIdentity(claims, "email");
        var claimsPrincipal = new ClaimsPrincipal(claimsIdentity);

        await HttpContextAccessor.HttpContext!.SignInAsync(claimsPrincipal);
        LoginStatus = LoginStatus.LoginSucceeded;
        HttpContextAccessor.HttpContext!.Response.Cookies.Delete(Options.Value.CorrelationIdCookieKey);
    }

}