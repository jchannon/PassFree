@using System.Net.Mail
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Options
@inject IHttpContextAccessor HttpContextAccessor;
@inject IOptions<PassFreeOptions> Options
@inject NavigationManager Navigation;
@inject PasswordlessAuthenticationProvider PasswordlessAuthenticationProvider;

<div class="passfree-login">
    <h2>@Options.Value.PageTitle</h2>

    @if (LoginStatus is LoginStatus.RequestEmail or LoginStatus.NotAuthenticated)
    {
        <form method="post" action="@Options.Value.LoginPath" @formname="passfree-login-form" data-enhance="false">
            <div class="passfree-form-group">
                <label for="emailaddress">Email Address</label>
                <input type="text" id="emailaddress" name="emailaddress" required/>
                <input type="submit" value="Submit"/>
            </div>
            <AntiforgeryToken/>
        </form>


        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="passfree-error">@ErrorMessage</div>
        }
    }

    @if (LoginStatus == LoginStatus.LoginLinkSent)
    {
        <div class="text-center"
             data-test="login-link-sent">
            <p>We have sent you a login link.</p>
            <p>Please check your inbox and click the link to login.</p>
            <p>
                Wrong email or no email received?
                <a href="@Options.Value.DefaultRedirectPath"
                   class="link">Try again.</a>
            </p>
        </div>
    }

    @if (LoginStatus == LoginStatus.LoginFailed)
    {
        <p data-test="login-failed-text"
           class="text-center">Login failed. This could be because your area not authorized, or your login link expired,
            or you are trying to log in from another device or browser.</p>
        <p class="text-center">
            <a href="@Options.Value.DefaultRedirectPath"
               class="btn btn-primary">Try again.</a>
        </p>
    }

    @if (LoginStatus == LoginStatus.LoginSucceeded)
    {
        <div class="text-center"
             x-data="loginCountdown()"
             x-init="init()">
            <h1 class="text-2xl mb-5">Login Succeeded.</h1>
            <p x-text="displayText"></p>
            <em>
                If you are not redirected, or want to navigate quicker, please click
                <a data-test="login-redirect-link"
                   href="@Options.Value.SuccessRedirectPath"
                   class="link">here.</a>
            </em>
        </div>
    }
</div>
<script defer src="https://cdn.jsdelivr.net/npm/@@alpinejs/csp@3.15.0/dist/cdn.min.js"
        integrity="sha384-/RME6pSq0zKJyBifgNWPb3I8kZckbbyQzvFaUqSyfcw3anF1SmYxV5XUPlkZxTBZ"
        crossorigin="anonymous"></script>

<script>
    function loginCountdown() {
        return {
            redirectCount: 4,
            get displayText() {
                return `You will be redirected to the home page in ${this.redirectCount} seconds.`;
            },
            init() {
                const startTime = Date.now();
                const duration = 4000;

                const update = () => {
                    const elapsed = Date.now() - startTime;
                    const remaining = Math.max(0, Math.ceil((duration - elapsed) / 1000));
                    this.redirectCount = remaining;

                    if (remaining > 0) {
                        requestAnimationFrame(update);
                    } else {
                        window.location.href = '@Options.Value.SuccessRedirectPath';
                    }
                };

                requestAnimationFrame(update);
            }
        }
    }
</script>

@code {
    [SupplyParameterFromQuery] private string? ErrorMessage { get; set; }

    [SupplyParameterFromQuery] private string? Status { get; set; }

    public LoginStatus LoginStatus { get; set; }

    [SupplyParameterFromQuery] public string? AuthToken { get; set; }


    protected override async Task OnInitializedAsync()
    {
        LoginStatus = !string.IsNullOrWhiteSpace(Status) ? Enum.Parse<LoginStatus>(Status) : LoginStatus.NotAuthenticated;

        if (HttpContextAccessor.HttpContext?.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("");
            return;
        }

        if (LoginStatus == LoginStatus.NotAuthenticated)
        {
            return;
        }

        if (LoginStatus == LoginStatus.LoginLinkSent && string.IsNullOrWhiteSpace(AuthToken))
        {
            return;
        }

        if (LoginStatus == LoginStatus.LoginLinkSent && !string.IsNullOrWhiteSpace(AuthToken))
        {
            var request = HttpContextAccessor.HttpContext?.Request!;
            // A login link is being followed
            // Get correlation cookie
            if (!request.Cookies.TryGetValue(Options.Value.CorrelationIdCookieKey, out var correlationIdToken))
            {
                LoginStatus = LoginStatus.LoginFailed;
                return;
            }

            // Validate auth and correlation tokens.
            var (validationResult, user) = PasswordlessAuthenticationProvider.ValidateTokens(AuthToken, correlationIdToken);
            if (validationResult != PasswordLessAuthenticaionTokenValidationResult.Success)
            {
                LoginStatus = LoginStatus.LoginFailed;
                return;
            }

            // Tokens are valid, check authorization
            var isAuthorized = await IsAuthorizedToLogin(user);
            if (!isAuthorized)
            {
                LoginStatus = LoginStatus.LoginFailed;
                return;
            }

            // Sign them in
            var email = user.Address;
            var claims = new[]
            {
                new Claim("email", email)
            };

            var claimsIdentity = new ClaimsIdentity(claims, "email");
            var claimsPrincipal = new ClaimsPrincipal(claimsIdentity);
            await HttpContextAccessor.HttpContext!.SignInAsync(claimsPrincipal);
            LoginStatus = LoginStatus.LoginSucceeded;
            HttpContextAccessor.HttpContext!.Response.Cookies.Delete(Options.Value.CorrelationIdCookieKey);
        }
    }

    private async Task<bool> IsAuthorizedToLogin(MailAddress mailAddress)
    {
        //check database
        await Task.Delay(10);
        return true;
    }


}
