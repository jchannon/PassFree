@using System.Net.Mail
@using System.Security.Claims
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Options
@inject IHttpContextAccessor HttpContextAccessor;
@inject IOptions<PassFreeOptions> Options
@inject NavigationManager Navigation;
@inject PasswordFreeAuthenticationProvider PasswordFreeAuthenticationProvider;
@inject IPassFreeService PassFreeService;

<div class="passfree-login">
    <h2>@Options.Value.PageTitle</h2>

    @if (LoginStatus is LoginStatus.RequestEmail or LoginStatus.NotAuthenticated)
    {
        <form method="post" action="@Options.Value.LoginPath" @formname="passfree-login-form" data-enhance="false">
            <div class="passfree-form-group">
                <label for="emailaddress">Email Address</label>
                <input type="text" id="emailaddress" name="emailaddress" required/>
                <input type="submit" value="Submit"/>
            </div>
            <AntiforgeryToken/>
        </form>


        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="passfree-error">@ErrorMessage</div>
        }
    }

    @if (LoginStatus == LoginStatus.LoginLinkSent)
    {
        <div class="login-link-sent">
            <p class="text">We have sent you a login link.</p>
            <p class="text">Please check your inbox and click the link to login.</p>
            <p class="text">
                Wrong email or no email received?
                <a href="@Options.Value.DefaultRedirectPath"
                   class="link">Try again.</a>
            </p>
        </div>
    }

    @if (LoginStatus == LoginStatus.LoginFailed)
    {
        <div class="login-failed">
            <p class="text">Login failed. This could be because you are not authorized, or your login link
                expired,
                or you are trying to log in from another device or browser.</p>
            <p class="text">
                <a href="@Options.Value.DefaultRedirectPath"
                   class="link">Try again.</a>
            </p>
        </div>
    }

    @if (LoginStatus == LoginStatus.LoginSucceeded)
    {
        <div class="login-succeeded" id="login-succeeded">
            <h3 class="text">Login Succeeded.</h3>
            <p class="text" id="displayText"></p>
            <em>
                If you are not redirected, or want to navigate quicker, please click
                <a href="@Options.Value.SuccessRedirectPath"
                   class="link">here.</a>
            </em>
        </div>

        <script>
            (function () {
                let container = document.getElementById('login-succeeded');
                if (!container) {
                    return;
                }

                let textEl = document.getElementById('displayText');
                let durationMs = 4000; // 4 seconds
                let start = performance.now();

                function update(now) {
                    let elapsed = now - start;
                    let remainingMs = Math.max(0, durationMs - elapsed);
                    let seconds = Math.ceil(remainingMs / 1000);
                    if (textEl) {
                        textEl.textContent = 'You will be redirected to the home page in ' + seconds + ' seconds.';
                    }

                    if (remainingMs > 0) {
                        requestAnimationFrame(update);
                    } else {
                        window.location.href = '@Options.Value.SuccessRedirectPath';
                    }
                }

                requestAnimationFrame(update);
            })();
        </script>
    }
</div>


@code {
    [SupplyParameterFromQuery] private string? ErrorMessage { get; set; }

    [SupplyParameterFromQuery] private string? Status { get; set; }

    private LoginStatus LoginStatus { get; set; }

    [SupplyParameterFromQuery] public string? AuthToken { get; set; }


    protected override async Task OnInitializedAsync()
    {
        LoginStatus = !string.IsNullOrWhiteSpace(Status)
            ? Enum.Parse<LoginStatus>(Status)
            : LoginStatus.NotAuthenticated;

        if (HttpContextAccessor.HttpContext?.User.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("");
            return;
        }

        if (ShouldSkipProcessing())
        {
            return;
        }

        if (LoginStatus == LoginStatus.LoginLinkSent && !string.IsNullOrWhiteSpace(AuthToken))
        {
            await ProcessLoginAsync();
        }
    }

    private bool ShouldSkipProcessing()
    {
        return LoginStatus is LoginStatus.NotAuthenticated
                   or LoginStatus.RequestEmail
                   or LoginStatus.LoginSucceeded
                   or LoginStatus.LoginFailed
               || (LoginStatus == LoginStatus.LoginLinkSent && string.IsNullOrWhiteSpace(AuthToken));
    }

    private async Task ProcessLoginAsync()
    {
        var request = HttpContextAccessor.HttpContext?.Request!;

        if (!request.Cookies.TryGetValue(Options.Value.CorrelationIdCookieKey, out var correlationIdToken))
        {
            LoginStatus = LoginStatus.LoginFailed;
            return;
        }

        var (validationResult, user) = PasswordFreeAuthenticationProvider.ValidateTokens(AuthToken, correlationIdToken);
        if (validationResult != PassFreeAuthenticaionTokenValidationResult.Success)
        {
            LoginStatus = LoginStatus.LoginFailed;
            return;
        }

        var isAuthorized = await PassFreeService.IsAuthorizedToLogin(user);
        if (!isAuthorized)
        {
            LoginStatus = LoginStatus.LoginFailed;
            return;
        }

        await SignInUserAsync(user);
    }

    private async Task SignInUserAsync(MailAddress user)
    {
        var claims = new[] { new Claim("email", user.Address) };
        var claimsIdentity = new ClaimsIdentity(claims, "email");
        var claimsPrincipal = new ClaimsPrincipal(claimsIdentity);

        await HttpContextAccessor.HttpContext!.SignInAsync(claimsPrincipal);
        LoginStatus = LoginStatus.LoginSucceeded;
        HttpContextAccessor.HttpContext!.Response.Cookies.Delete(Options.Value.CorrelationIdCookieKey);
    }

}